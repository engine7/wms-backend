<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="inventoryDAO">
	<!-- Hsql과 호환때문에 아래 resultMap 추가: KIK -->
	<resultMap id="inventoryList" type="egovframework.let.wms.inventory.service.InventoryVO">
			<result property="whCd" column="whCd" />
			<result property="lotNo" column="lotNo" />
			<result property="cellNo" column="cellNo" />
			<result property="invnQty" column="invnQty" />
			<result property="avlbQty" column="avlbQty" />
			<result property="allocQty" column="allocQty" />
			<result property="hldQty" column="hldQty" />
			<result property="insUserId" column="insUserId" />
			<result property="insDatetime" column="insDatetime" />
			<result property="updUserId" column="updUserId" />		
			<result property="updDatetime" column="updDatetime" />
	</resultMap>
	<select id="selectInventoryList" parameterType="userSearchVO" resultMap="inventoryList">
		/* selectInventoryList */
	
		SELECT 	whCd		
				, lotNo      
				, cellNo     
				, invnQty    
				, avlbQty    
				, allocQty   
				, hldQty     
				, insUserId  
				, insDatetime
				, updUserId  
				, updDatetime
		FROM	(
				    SELECT 
				        	WH_CD				AS whCd		
							, LOT_NO            AS lotNo      
							, CELL_NO           AS cellNo     
							, INVN_QTY          AS invnQty    
							, AVLB_QTY          AS avlbQty    
							, ALLOC_QTY         AS allocQty   
							, HLD_QTY           AS hldQty     
							, INS_USER_ID       AS insUserId  
							, INS_DATETIME      AS insDatetime
							, UPD_USER_ID       AS updUserId  
							, UPD_DATETIME      AS updDatetime
				    FROM    WMT_CST_STRG
				) A
	    WHERE 1=1
	    <if test="searchCondition == 0">AND
	    	whCd LIKE CONCAT('%' , #{searchKeyword}, '%')
	    </if>
	    <if test="searchCondition == 1">AND
	    	lotNo LIKE CONCAT('%' , #{searchKeyword}, '%')
	    </if>
	    <if test="searchCondition == 2">AND
	    	cellNo LIKE CONCAT('%' , #{searchKeyword}, '%')
	    </if>
	    ORDER BY whCd, lotNo, cellNo DESC
	    LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
   	</select>
    	
   	<select id="selectInventoryListTotCnt" parameterType="userSearchVO" resultType="int">
   		/* selectInventoryListTotCnt */
   	
        SELECT COUNT(1) totcnt
        FROM	(
	        		SELECT 
				        	WH_CD				AS whCd		
							, LOT_NO            AS lotNo      
							, CELL_NO           AS cellNo     
							, INVN_QTY          AS invnQty    
							, AVLB_QTY          AS avlbQty    
							, ALLOC_QTY         AS allocQty   
							, HLD_QTY           AS hldQty     
							, INS_USER_ID       AS insUserId  
							, INS_DATETIME      AS insDatetime
							, UPD_USER_ID       AS updUserId  
							, UPD_DATETIME      AS updDatetime
				    FROM    WMT_CST_STRG
	    		) A
        WHERE 1=1
        <if test="searchCondition == 0">AND
	    	whCd LIKE CONCAT('%' , #{searchKeyword}, '%')
	    </if>
	    <if test="searchCondition == 1">AND
	    	lotNo LIKE CONCAT('%' , #{searchKeyword}, '%')
	    </if>
	    <if test="searchCondition == 2">AND
	    	cellNo LIKE CONCAT('%' , #{searchKeyword}, '%')
	    </if>
    </select>
    
    <insert id="insertInventory">
    	/* insertInventory */
    
        INSERT INTO WMT_CST_STRG 
            (   
                WH_CD		
				, LOT_NO      
				, CELL_NO     
				, INVN_QTY    
				, AVLB_QTY    
				, ALLOC_QTY   
				, HLD_QTY     
				, INS_USER_ID 
				, INS_DATETIME
				, UPD_USER_ID 
				, UPD_DATETIME        
			)
          VALUES
          	(
                #{whCd}		
				, #{lotNo}      
				, #{cellNo}     
				, IFNULL (NULLIF(#{invnQty},''), 0)    
				, IFNULL (NULLIF(#{avlbQty},''), 0)
				, IFNULL (NULLIF(#{allocQty},''), 0)   
				, IFNULL (NULLIF(#{hldQty}, ''), 0)     
				, 'sklee'  
				, DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
				, 'sklee'  
				, DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
            )           
    </insert>
    
    <select id="selectInventory" resultType="inventoryVO">
    	/* selectInventory */
    
        SELECT	WH_CD		
				, LOT_NO      
				, CELL_NO     
				, INVN_QTY    
				, AVLB_QTY    
				, ALLOC_QTY   
				, HLD_QTY     
				, INS_USER_ID 
				, INS_DATETIME
				, UPD_USER_ID 
				, UPD_DATETIME
          FROM	WMT_CST_STRG
         WHERE	1 = 1
           AND	WH_CD = #{whCd}	
           AND	LOT_NO = #{lotNo}     
           AND	CELL_NO = #{cellNo}
    </select>
    
    <update id="updateInventory">
    	/* updateInventory */
    
        UPDATE	WMT_CST_STRG 
           SET	INVN_QTY = #{invnQty}   
				, AVLB_QTY = #{avlbQty}    
				, ALLOC_QTY = #{allocQty}   
				, HLD_QTY = #{hldQty}     
				, UPD_USER_ID = 'sklee'
				, UPD_DATETIME = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
         WHERE	1 = 1
           AND	WH_CD = #{whCd}	
           AND	LOT_NO = #{lotNo}     
           AND	CELL_NO = #{cellNo}
    </update>
    
    <delete id="deleteInventory">
    	/* deleteInventory */
    
		DELETE 
		  FROM	WMT_CST_STRG 
         WHERE	1 = 1
           AND	WH_CD = #{whCd}	
           AND	LOT_NO = #{lotNo}     
           AND	CELL_NO = #{cellNo}
    </delete>
    
    <select id="checkIdDplct" resultType="int">
    
    	/* checkIdDplct */
    	
    	SELECT	COUNT(1) usedCnt
    	  FROM	WMT_CST_STRG
    	 WHERE	1 = 1
           AND	WH_CD = #{whCd}	
           AND	LOT_NO = #{lotNo}     
           AND	CELL_NO = #{cellNo}
    
    </select>
    
</mapper>